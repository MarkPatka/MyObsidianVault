**Apache Kafka** — распределённый программный [[Message Broker Definition |брокер сообщений]]  с открытым исходным кодом, разрабатываемый в рамках фонда Apache на языках Java и Scala. 

**Цель проекта** — создание горизонтально масштабируемой платформы для [[3. Kafka Key Concepts|обработки потоковых данных]] в реальном времени с высокой пропускной способностью и низкой задержкой. Kafka может подключаться к внешним системам (для импорта и экспорта данных) через [[4.8. Kafka Connect]], а также может использоваться в задачах больших данных при помощи библиотеки [[4.9. Kafka Streams]].

Использует собственный двоичный протокол передачи данных на основе [[TCP]], группирующий сообщения для снижения накладных расходов на сеть.

**Как работает Kafka, в двух словах?**

Kafka — это распределенная система, состоящая из серверов и клиентов, которые взаимодействуют через высокопроизводительный сетевой TCP-протокол. Её можно развернуть на bare-metal-оборудовании, виртуальных машинах и в контейнерах как в локальных, так и в облачных средах.

- **Серверы:** Kafka работает как кластер из одного или нескольких серверов, которые могут охватывать несколько центров обработки данных или облачных регионов. Некоторые из этих серверов формируют слой хранения, называемый брокерами (brokers). Другие серверы запускают Kafka Connect для непрерывного импорта и экспорта данных в виде потоков событий для интеграции Kafka с вашими существующими системами, такие как реляционные базы данных, а также с другими кластерами Kafka. Чтобы вы могли реализовывать критически важные сценарии использования, кластер Kafka является highly scalable и отказоустойчивым: если какой-либо из его серверов выходит из строя, другие серверы берут на себя его работу, чтобы обеспечить непрерывную работу без потери данных.
    
- **Клиенты:** Они позволяют вам писать распределенные приложения и микросервисы, которые читают, записывают и обрабатывают потоки событий параллельно, в крупных масштабах и отказоустойчиво, даже в случае сетевых проблем или сбоев машин. Kafka поставляется с несколькими такими встроенными клиентами, которые дополняются десятками клиентов, предоставляемых сообществом Kafka: клиенты доступны для Java и Scala (включая библиотеку более высокого уровня Kafka Streams), для Go, Python, C/C++ и многих других языков программирования, а также через [[REST API]].
       
[[3. Kafka Key Concepts|2. Основные концепции]]
[[2. Kafka Key Tasks and Properties|3. Свойства и задачи Kafka]]
[[4. Kafka Architecture|4. Архитектура Kafka]]
[[5. Links|5. Источники]]



00:00 Введение в Kafka

• Kafka — популярная технология, используемая в различных проектах.
• Влад, бэкенд-разработчик из Амстердама, объясняет ключевые особенности Kafka.
• Видео поможет понять, что такое Kafka и зачем она нужна.

00:57 Структура веб-приложений

• Веб-приложения состоят из фронтендов, бэкендов и баз данных.
• Фронтенды взаимодействуют с бэкендами через интернет.

01:53 Монолиты и микросервисы

• Монолиты — это приложения с единой кодовой базой, которые сложно разрабатывать и поддерживать.
• Микросервисы — это отдельные проекты, выполняющие конкретные функции и взаимодействующие через интернет.
• Микросервисы позволяют легче разрабатывать, запускать и масштабировать приложения.

03:46 Взаимодействие микросервисов

• Микросервисы взаимодействуют через интернет, используя протокол HTTP.
• Передача данных по интернету имеет свои проблемы.

04:39 Брокеры сообщений

• Для решения проблем передачи данных используются брокеры сообщений, такие как Kafka.
• Kafka помогает эффективно передавать данные между микросервисами.

05:10 Проблемы взаимодействия микросервисов

• Взаимодействие между микросервисами по интернету имеет проблемы из-за ненадёжности сетей.
• Данные могут потеряться или не быть доставлены полностью.
• Разработчикам приходится учитывать возможные сбои и разрабатывать стратегии повторной отправки данных.

06:07 Проблемы с протоколом HTTP

• Сети, включая интернет, ненадёжны, что приводит к потерям данных.
• Программа-отправитель должна ждать ответа от программы-получателя, что может замедлять работу системы.
• Асинхронная отправка данных может решить проблему, но не всегда удобна.

08:55 Риски потери данных

• Данные, обрабатываемые программой-получателем, хранятся в оперативной памяти компьютера.
• При сбое компьютера данные могут быть потеряны.
• Потеря важных данных может привести к недовольству пользователей и потере бизнеса.

12:58 Масштабируемость и надёжность

• Увеличение числа микросервисов, получающих данные, требует добавления логики в код отправителя.
• Каждое изменение кода увеличивает риск ошибок и снижает надёжность системы.
• Система становится менее масштабируемой и эффективной.

14:54 Брокеры сообщений и Kafka

• Брокеры сообщений, такие как Kafka, решают проблемы надёжности и масштабируемости.
• Они обеспечивают промежуточное хранение данных, предотвращая их потерю при сбоях.
• Данные сохраняются в брокере и могут быть восстановлены получателем при необходимости.

16:03 Введение в брокер сообщений

• Брокер сообщений — это программа, которая принимает и сохраняет данные, передаваемые между программами.
• Данные обычно передаются в текстовом формате.
• Получатель данных постоянно опрашивает брокер сообщений на наличие новых данных.

17:00 Терминология

• Программа, отправляющая данные в брокер сообщений, называется продюсером.
• Программа-получатель данных называется консьюмером.

17:44 Преимущества использования брокера сообщений

• Асинхронная обработка данных: микросервис постов отправляет данные в брокер, который гарантирует их доставку.
• Микросервис постов может заниматься другими делами, не ожидая ответа от микросервиса нотификации.

18:33 Гарантия доставки данных

• Брокер сообщений обеспечивает гарантию доставки данных, даже если микросервис нотификации не успел их обработать.
• Микросервис постов не должен ждать ответа от консьюмера.

20:16 Реакция на сбои

• Если микросервис нотификации отключается, брокер сообщений сохраняет данные и позволяет их обработать повторно.
• Система становится более надёжной благодаря брокеру сообщений.

22:11 Масштабируемость системы

• Новые микросервисы могут подключаться к брокеру сообщений и получать данные без изменения исходного микросервиса.
• Система гибко масштабируется без необходимости изменения исходного кода.

25:02 Вопрос о надёжности брокера сообщений

• Возникает вопрос о потере данных при сбое компьютера с брокером сообщений.
• Необходимо рассмотреть меры по обеспечению надёжности брокера сообщений.

25:08 Введение в брокеры сообщений

• Брокеры сообщений — это программы, которые передают данные из одной точки в другую и сохраняют их.
• Примеры брокеров: ActiveMQ, Redis, Kafka.
• Kafka — самый популярный брокер в современных проектах.

26:08 Особенности Kafka

• Kafka позволяет публиковать данные из микросервисов постов и потреблять их микросервисами уведомлений.
• Сообщения могут иметь разную природу в зависимости от источника.
• Пример: сообщения о лайках и комментариях отличаются по содержанию.

27:05 Проблема с универсальными сообщениями

• Если все сообщения публикуются в Kafka без разбора, получателям сложно понять их содержание.
• Это делает код получателей сложным и неэффективным.
• Решение: использование топиков в Kafka.

28:05 Понятие топиков в Kafka

• Топик в Kafka — это канал для сообщений определённого типа.
• Разработчик создаёт топики для разных типов сообщений: посты, группы, комментарии, лайки.
• Получатели знают, что сообщения относятся к определённым темам.

29:55 Преимущества топиков

• Топики помогают получателям не путаться в потоке сообщений.
• Пример с телевизором: разные каналы для новостей и спорта.
• В Kafka получатели подключаются к конкретным топикам для получения нужных сообщений.

30:53 Взаимодействие микросервисов с топиками

• Микросервисы могут выступать продюсерами и консьюмерами в разных топиках.
• Это позволяет строить сложные системы с преобразованием данных.
• Топики обеспечивают перенаправление данных между микросервисами.

32:39 Масштабирование системы

• При масштабировании системы новые микросервисы подключаются к нужным топикам.
• Разработчики должны определить, какие типы сообщений нужны в приложении.
• Важно правильно распределять данные по топикам для эффективной работы системы.

33:18 Организация взаимодействия системы

• Инженер должен решать проблемы взаимодействия системы.
• Топики предоставляют гибкость в организации взаимодействия.
• Данные передаются по интернету между продюсером и брокером сообщений.

34:13 Преимущества Kafka

• Kafka предоставляет гарантии доставки сообщений.
• Можно настроить Kafka для гарантии доставки сообщений максимум один раз.
• Гарантия «максимум один раз» означает, что сообщение может быть потеряно.

35:45 Проблемы при передаче данных

• При передаче данных по интернету возможны ошибки, приводящие к потере сообщений.
• Микросервис может не узнать о потере сообщения от Kafka.
• Сообщения могут теряться как при публикации, так и при потреблении.

36:31 Применение гарантии «максимум один раз»

• Гарантия «максимум один раз» полезна для данных, потеря которых не критична.
• Пример использования: передача аналитических данных или специфических логов.
• Ускорение доставки сообщений за счёт отказа от внутреннего сохранения данных.

39:15 Сравнение с Redis

• Redis предлагает гарантию «максимум один раз» и работает быстрее.
• Kafka ценится за гарантию «минимум один раз».

40:12 Гарантия «минимум один раз» в Kafka

• Producer ждёт подтверждения от Kafka о получении данных.
• Kafka сохраняет данные на жёсткий диск и отправляет подтверждение.
• Если подтверждение не получено, Producer пытается отправить данные повторно.

42:50 Проблема дублирования сообщений

• Дублирование сообщений может произойти из-за потери подтверждения.
• Kafka не удаляет дубликаты, они доставляются получателю.
• Получатель должен правильно обрабатывать дубликаты.

44:34 Обработка дубликатов

• Разработчики должны учитывать вероятность дублирования сообщений.
• Важно иметь фильтр для устранения дубликатов в потребителе сообщений.
• Дублирование важных сообщений может привести к серьёзным последствиям, например, к двойному списанию денег.

46:02 Идемпотентность консьюмера

• Идемпотентный консьюмер обрабатывает дубликаты сообщений так, будто они всегда были одним сообщением.
• Дубликаты не влияют на работу приложения.
• Гарантии идемпотентности можно обеспечить разными способами.

46:55 Обеспечение идемпотентности

• Иногда приложение автоматически идемпотентно, но иногда нужно добавлять фильтры или проверять базу данных.
• Разработчик должен рассмотреть, является ли консьюмер идемпотентным и как этого добиться.

47:54 Репликация в Kafka

• Kafka запускается на нескольких серверах для обеспечения репликации данных.
• Данные сохраняются на обоих серверах, что гарантирует их сохранность при выходе из строя одного из серверов.
• Кластер Kafka должен включать минимум три машины для снижения риска потери данных.

50:43 Партишины в Kafka

• Партишины — это части топика, которые содержат данные одного типа.
• Каждое сообщение попадает только в один партишин внутри топика.
• Это позволяет эффективно использовать ресурсы и масштабировать систему.

52:32 Пример работы партишинов

• Если топик содержит данные о постах, то все партишины этого топика будут содержать только данные о постах.
• Сообщение о новом посте попадает только в один из пяти партишинов топика постов.
• На другой стороне сообщение будет забираться из соответствующего партишина.

53:14 Распределение сообщений в топике

• Сообщения равномерно распределяются по доступным партишинам.
• Консьюмер забирает сообщения из всех партишинов без приоритета.
• Данные одного типа распределяются по разным каналам.

54:06 Преимущества параллельных каналов

• Пять параллельных каналов позволяют публиковать и забирать данные одновременно.
• Один канал работает как очередь, что ограничивает пропускную способность.
• Увеличение пропускной способности топика.

54:54 Нарушение порядка сообщений

• При наличии нескольких партишинов порядок сообщений может нарушаться.
• Сообщения из разных партишинов могут потребляться в любом порядке.

55:51 Гарантия порядка сообщений

• В Кафке можно гарантировать порядок сообщений, добавляя ключ к сообщению.
• Сообщения с одинаковым ключом направляются в один и тот же партишин.
• Без ключа сообщения распределяются равномерно по партишинам.

57:32 Масштабирование Кафки

• Распределение партишинов по разным серверам увеличивает производительность.
• Каждый сервер имеет ограниченные ресурсы, но распределение данных по нескольким серверам позволяет эффективнее использовать ресурсы.

59:55 Проблема потери данных

• При выходе из строя одного сервера возможна потеря данных.
• Разработчики Кафки решили эту проблему путём копирования данных на другие серверы.

01:00:55 Репликация данных

• Данные копируются на другие серверы для обеспечения надёжности.
• Консьюмер забирает сообщения с основной копии, а копия нужна для восстановления данных при выходе из строя основного сервера.

01:02:34 Подтверждение доставки

• Кафка подтверждает доставку данных только после обновления основного и резервного партишинов.
• Чем больше копий данных, тем выше гарантии доставки и надёжность системы.

01:03:20 Заключение

• Подразбиение топика на партишины позволяет эффективно распределять данные и гарантировать их сохранность.
• Репликация данных на разные машины обеспечивает надёжность системы.

01:03:51 Введение в партишины в Kafka

• Партишины позволяют Kafka использовать дополнительные серверы для репликации данных.
• Сообщения с одинаковым ключом попадают в один и тот же партишин, обеспечивая последовательную доставку.
• Параллельная доставка делает Kafka мощной для обработки больших объёмов данных.

01:04:50 Масштабирование Kafka

• Kafka позволяет масштабировать пропускную способность системы до бесконечности.
• Современные приложения обрабатывают миллиарды сообщений в секунду, и один компьютер не может справиться с такой нагрузкой.
• Распределение данных по множеству машин позволяет эффективно обрабатывать большие объёмы информации.

01:05:43 Пример использования Kafka в социальной сети

• Разработка фичей для социальной сети с использованием Kafka и микросервисов.
• Микросервис постов и микросервис модификации обрабатывают сообщения о постах и модификациях.
• При увеличении числа пользователей возникают проблемы с нагрузкой на микросервисы и Kafka.

01:07:27 Решение проблем с нагрузкой

• Запуск копий микросервиса постов на разных серверах распределяет нагрузку.
• Запуск копий микросервиса модификации на разных серверах позволяет равномерно обрабатывать данные.
• Данные не хранятся в состоянии, что обеспечивает надёжность системы.

01:10:38 Масштабирование сервера Kafka

• Установка нескольких серверов Kafka для распределения партишинов.
• Каждый сервер обрабатывает свою часть данных, увеличивая пропускную способность системы.
• В случае сбоя одного сервера данные перенаправляются на другой, обеспечивая надёжность системы.

01:13:28 Преимущества Kafka

• Kafka предоставляет гарантии доставки и высокую масштабируемость.
• Гибкость настроек позволяет адаптировать систему под разные требования.
• Возможность выбора между различными гарантиями доставки, такими как «ле ваннс» и «мост ваннс».

01:15:08 Заключение

• Понимание работы Kafka помогает пройти собеседования на позиции джуна или мидла.
• Автор призывает подписаться на канал и посетить его телеграм-канал для получения дополнительных технических материалов.

